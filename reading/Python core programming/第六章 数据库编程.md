# 第六章 数据库编程

## 底层存储

数据库通常使用文件系统作为基本的持久化存储，它可以是普通的操作系统文件、专用 的操作系统文件，甚至是原始的磁盘分区。

## 用户接口

大多数数据库系统提供了命令行工具，可以用其执行 SQL 语句或查询。此外还有一些 GUI 工具，使用命令行客户端或数据库客户端库，向用户提供更加便捷的界面。

## 数据库

一个关系数据库管理系统(RDBMS)通常可以管理多个数据库，比如销售、市场、用 户支持等，都可以在同一个服务端(如果 RDBMS 基于服务器，可以这样。不过一些简单 的系统通常不是基于服务器的)。在本章将要看到的例子中，MySQL 是一种基于服务的 RDBMS，因为它有一个服务器进程始终运行以等待命令行输入;而 SQLite 和 Gadfly 则不 会运行服务器。

## 组件

数据库存储可以抽象为一张表。每行数据都有一些字段对应于数据库的列。每一列的表 定义的集合以及每个表的数据类型放到一起定义了数据库的模式(schema)。
数据库可以创建(create)和删除(drop)，表也一样。往数据库里添加新行叫做插入(insert)， 修改表中已存在的行叫做更新(update)，而移除表中已存在的行叫做删除(delete)。这些动 作通常称为数据库命令或操作。使用可选的条件请求获取数据库中的行称为查询(query)。
当查询一个数据库时，可以一次性取回所有结果(行)，也可以逐条遍历每个结果行。一 些数据库使用游标的概念来提交 SQL 命令、查询以及获取结果，不管是一次性获取还是逐行 获取都可以使用该概念。

## SQL

数据库命令和查询操作是通过 SQL 语句提交给数据库的。虽然并非所有数据库都使用 SQL 语句，但是大多数关系数据库使用。下面是一些 SQL 命令示例。请注意，大部分数据 库都是不区分大小写的，尤其是针对数据库命令而言。一般来说，对数据库关键字使用大 写字母是最为广泛接受的风格。大多数命令行程序需要一条结尾的分号(;)来结束这条 SQL 语句。

```
创建数据库

CREATE DATABASE test;

GRANT ALL ON test.* to user(s);

```

第一行创建了一个名为“test”的数据库，假设你是数据库的管理员，第二行语句可以为 指定用户(或所有用户)提升权限，以便他们可以执行下述数据库操作。

使用数据库

```
USE test;
```

如果你已经登录一个数据库系统，但还没有选择你希望使用的数据库，这条简单的语句 可以让你指定一个数据库，用来执行数据库操作。

删除数据库

```
DROP DATABASE test;
```

这条简单的语句可以从数据库中移除所有表和数据，并将其从系统中删除。

创建表

```
CREATE TABLE users (login VARCHAR(8), userid INT, projid INT);
```

这条语句创建一个新表，其中包含字符串列 login，以及两个整型列:userid 和 projid。 

删除表

```
DROP TABLE users;
```

这条简单的语句可以删除数据库中的一个表，并清空其中的所有数据。

插入行

```
INSERT INTO users VALUES('leanna', 2111, 1);
```

可以使用insert语句向数据库插入一个新行。需要指定表明以及其中每列的数值。对于本例而言，字符串“leanna”对应于login参数，211对应userid，1对应projid。

更新行

```
UPDATE users SET projid=4 WHERE projid=2;
UPDATE users SET projid=1 WHERE userid=311;
```

为了修改表中已经存在的行，需要使用 UPDATE 语句。使用 SET 来确定要修改的列， 并提供条件来确定要修改的行。在第一个例子中，所有“project ID”(即 projid)为 2 的用户 需要改为 4。而在第二个例子中，将指定用户(这里是 UID 为 311 的用户)移到编号为#1 的 项目组中。o

删除行

```
DELETE FROM users WHERE projid=%d;
DELETE FROM users;
```

为了删除表中的行，需要使用 DELETE FROM 命令，指定准备删除的行的表名以及可选 的条件。如果没有这个条件，就会像第二个例子一样，把所有行都删除了。
既然你对数据库的基本概念已经有了一个大致的了解，这就会使本章剩余部分及其示例 的学习变得更加简单。如果你还需要额外的帮助，有很多数据库教程书籍可供参考。


***

### 数据库和 Python

下面我们将学习 Python 的数据库 API，并了解如何使用 Python 访问关系数据库。访问 数据库包括直接通过数据库接口访问和使用 ORM 访问两种方式。其中使用 ORM 访问的方 式不需要显式给出 SQL 命令，但也能完成相同的任务。

诸如数据库原理、并发性、模式、原子性、完整性、恢复、比较复杂的左连接、触发器、 查询优化、事务性、存储过程等主题都不在本书要讲解的范围之内，因此本章中不会对其进 行讨论，而是直接在 Python 应用中使用。本章将介绍如何在 Python 框架下对 RDBMS 进行 存储和获取数据的操作。之后你可以决定使用哪种方式更适合于你当前的项目或应用，而示 例代码的学习可以让你更加快速地起步。如果你需要将Python应用与某种数据库系统结合起 来，我们的目标就是能够让你尽快掌握所有相关的事情。

我们还会打破只使用“功能齐备”的 Python 标准库的模式(尽管我们的最初目标是只使 用标准库)。可以明确的是，在 Python 的领域中，与数据库协同工作已经变成日常应用开发 中的一个核心组件。


作为一名软件工程师，到目前为止的职业生涯中，你可能还没学习数据库相关的一些 知识，比如:如何使用数据库(命令行和/或 GUI)，如何使用 SQL 语句获取数据，如何 添加或更新数据库中的信息等。如果 Python 是你的编程工具，一旦你向 Python 应用中添 加了数据库访问，就会使很多麻烦的工作由 Python 为你代劳了。首先我们会描述什么是 Python 的数据库 API，或者说是 DB-API，然后会给出一些符合这一标准的数据库接口的 例子。

我们将展示几个使用流行的开源 RDBMS 的例子。不过，我们不会对开源产品和商业产 品之间的对比进行讨论。如果要适配其他 RDBMS，使用方法也会非常直接。此外，有一个 数据库需要特别提及，这就是 Aaron Watter 的 Gadfly，因为这是一个完全使用 Python 编写的 简单的 RDBMS。

在 Python 中数据库是通过适配器的方式进行访问的。适配器是一个 Python 模块，使用 它可以与关系数据库的客户端库(通常是使用 C 语言编写的)接口相连。一般情况下会推荐 所有的 Python 适配器应当符合 Python 数据库特殊兴趣小组(DB-SIG)的 API 标准。适配器 将会是本章中首先要讨论的主题。

图 6-1 所示为编写 Python 数据库应用的结构，包括使用和没有使用 ORM 的情况。从图 6-1 中可以看出，DB-API 是连接到数据库客户端的 C 语言库的接口。


***

## Python 的 DB-API


从哪里可以找到数据库相关的接口呢?很简单，只需要前往Python官网的数据库主题部 分即可。在那里，你可以找到全面的当前版本 DB-API(2.0 版本)的链接，包括数据库模块、 文档、特殊兴趣小组等。从一开始起，DB-API 就被移动至 PEP 249 中(PEP 248 中的老版 DB-API 1.0 标准已经废弃)。那么，DB-API 是什么呢?

DB-API 是阐明一系列所需对象和数据库访问机制的标准，它可以为不同的数据库适配 器和底层数据库系统提供一致性的访问。就像很多基于社区的成果一样，DB-API 也是强需 求驱动的。

在过去的日子里，曾有这样一种场景:有很多种数据库，并且很多人实现了他们自己 的数据库适配器。就像做无用功一样。这些数据库和适配器是在不同的时间被不同的人实 现的，在功能上完全没有一致性可言。但是，这意味着使用这些接口的应用代码需要与他 们选择使用的数据库模块进行定制化处理，接口的任何改变都会导致应用代码的变更。

由此，为了解决 Python 数据库连接问题的特殊兴趣小组成立了，并且撰写了 1.0 版本的 DB-API。该 API 为不同的关系数据库提供了一致性的接口，并且使不同数据库间移植代码变 得更加简单，通常只需要修改几行代码即可。本章后面的部分你会看到一个相关的示例。

### 模块属性

DB-API 标准要求必须提供下文列出的功能和属性。一个兼容 DB-API 的模块必须定义表
6-1 所示的几个全局属性。

属性|描述
----|----
apilevel|需要适配兼容db-api版本
threadsafety|本模块的线程安全级别
paramstyle|本模块的SQL语句参数风格
connect()|Connect（）函数


数据属性

apilevel

该字符串(注意，不是浮点型)指明了模块需要兼容的 DB-API 最高版本，比如，1.0、 2.0 等。该属性的默认值是 1.0。


threadsafety


这是一个整型值，可选值如下。

0:不支持线程安全。线程间不能共享模块

1:最小化线程安全支持:线程间可以共享模块，但是不能共享连接。

2:适度的线程安全支持:线程间可以共享模块和连接，但是不能共享游标。

3:完整的线程安全支持:线程间可以共享模块、连接和游标。

如果有资源需要进行共享，那么就需要诸如自旋锁、信号量之类的同步原语来达到原子
锁定的目的。由于此目的，磁盘文件和全局变量都并不可靠，甚至还会干扰到标准的互斥操 作。查阅 threading 模块，或回顾第 4 章，以获取如何使用锁的更多信息。

参数风格

DB-API 支持以不同的方式指明如何将参数与 SQL 语句进行整合，并最终传递给服务器中执 行。该参数是一个字符串，用于指定构建查询行或命令时使用的字符串替代形式(见表 6-2)。


函数属性

connect()函数通过 Connection 对象访问数据库。兼容模块必须实现 connect()函数，该函 数创建并返回一个 Connection 对象。表 6-3 所示为 connect()的参数。

可以使用包含多个参数的字符串(DSN)来传递数据库连接信息，也可以按照位置传递每个 参数，或者是使用关键字参数的形式传入。下面是 PEP 249 中给出的使用 connect()函数的例子。

使用 DSN 还是独立参数主要基于所连接的系统。比如，如果你使用的是像 ODBC(Open Database Connectivity)或 JDBC(Java Database Connectivity)的 API，则需要使用 DSN; 而如果你直接使用数据库，则更倾向于使用独立的登录参数。另一个使用独立参数的原因 是很多数据库适配器并没有实现对 DSN 的支持。下面是一些没有使用 DSN 的 connect()调 用。需要注意的是，并不是所有的适配器都会严格按照标准实现，比如 MySQLdb 使用了 db 而不是 database。

* MySQLdb.connect(host='dbserv', db='inv', user='smith')

* PgSQL.connect(database='sales')

* psycopg.connect(database='template1', user='pgsql')

* gadfly.dbapi20.connect('csrDB', '/usr/local/database')

* sqlite3.connect('marketing/test')

异常 

异常同样需要包含在兼容的模块中，如表 6-4 所示。

异常|描述
----|----
Warning|警告异常基类
Error|错误异常基类
 Inerface Error|数据库借口错误
 DatabaseError| 数据库错误
    DataError|处理数据时出现错误
    OperationlError|数据库操作执行期间出现错误
    IntegrityError|数据库关系完整性错误
    ProgrammingError|SQL命令执行失败
    NotSupportedError|出现不支持的操作


### Connection 对象

应用与数据库之间进行通信需要建立数据库连接。它是最基本的机制，只有通过数据库 连接才能把命令传递到服务器，并得到返回的结果。当一个连接(或一个连接池)建立后， 可以创建一个游标，向数据库发送请求，然后从数据库中接收回应。

Connection 对象方法

Connection 对象不需要包含任何数据属性，不过应当定义表 6-5 所示的几个方法。

方法名|描述
------|------
close()|关闭数据库连接
commit()|提交当前事务
rollback()|取消当前事务
cursor()|使用该连接创建一个游标或类游标对象
errorhandle(cxn,cur,errcls,errval)|作为给定连接的游标的处理程序

当使用close时，这个连接将不能再使用，否则会进入到异常处理中。

如果数据库不支持事务处理，或启用了自动提交功能，commit方法都无法使用，如果你愿意，可以实现单独的方法来启动或者关闭自动提交功能。因为本方法是db-api红的一部分所以对于不支持事务处理的数据库而言，只需在方法实现“pass”即可。

和 commit()相似，rollback()方法也只有在支持事务处理的数据库中才有用。发生异常之 后，rollback()会将数据库的状态恢复到事务处理开始时。根据 PEP 249 所述，“关闭连接而不 事先提交变更，将会导致执行隐式回滚。”

如果 RDBMS 不支持游标，那么 cursor()仍然会返回一个尽可能模仿真实游标的对象。这 是最基本的要求。每个适配器开发者都可以为他的接口或数据库专门添加特殊属性。

DB-API 建议适配器开发者为连接编写所有的数据库模块异常(见表 6-4)，但并没 有做强制要求。如果没有，则认为 Connection 对象将会抛出对应模块级别的异常。当你 完成数据库连接并关闭游标时，需要对所有操作执行 commit()，并对你的连接执行 close()。

DB-API 建议适配器开发者为连接编写所有的数据库模块异常(见表 6-4)，但并没 有做强制要求。如果没有，则认为 Connection 对象将会抛出对应模块级别的异常。当你 完成数据库连接并关闭游标时，需要对所有操作执行 commit()，并对你的连接执行 close()。

### Cursor 对象

当建立连接后，就可以和数据库进行通信了。正如 6.1 节所述，游标可以让用户提交数 据库命令，并获得查询的结果行。Python DB-API游标对象总能提供游标的功能，即使是那 些不支持游标的数据库。此时，如果你创建了一个数据库适配器，还必须要实现 cursor 对象， 以扮演类似游标的角色。这样，无论你将数据库系统切换到支持游标的数据库还是不支持游 标的数据库，都能保持 Python 代码的一致性。

当游标创建好后，就可以执行查询或命令(或多个查询和命令)，并从结果集中取回一行 或多行结果。表 6-6 所示为 Cursor 对象的数据属性和方法。

游标对象最重要的属性是 execute*()和 fetch*()方法，所有针对数据库的服务请求都 是通过它们执行的。arraysize 数据属性在为 fetchmany()设置默认大小时非常有用。当然， 在不需要时关闭游标是个好主意，而如果你的数据库支持存储过程，可能会用到 callproc().

对象属性|描述
---|---
arraysize|使用 fetchmany()方法时，一次取出的结果行数，默认为 1
connection|创建此游标的连接(可选)
description|返回游标活动状态(7 项元组):(name, type_code, display_size, internal_ size, precision, scale, null_ok)，只有 name 和 type_code 是必需的
lastrowid|上次修改行的行 ID(可选;如果不支持行 ID，则返回 None)
rowcount|上次 execute*()方法处理或影响的行数
callproc( func [,args])|调用存储过程
close()|关闭游标
execute (op[,args])|执行数据库查询或命令
executemany (op，args)|类似 execute()和 map()的结合，为给定的所有参数准备并执行数据库查询 或命令
fetchone()|获取查询结果的下一行
fetchmany([size=cursor. arraysize])|获取查询结果的下面 size 行
fetchall()|获取查询结果的所有(剩余)行
__iter__()|为游标创建迭代器对象(可选，参考 next())
messages|游标执行后从数据库中获得的消息列表(元组集合，可选)
next ()|被迭代器用于获取查询结果的下一行(可选，类似 fetchone()，参考 __iter__())
nextset()|移动到下一个结果集合(如果支持)
rownumber|当前结果集中游标的索引(以行为单位，从 0 开始，可选)
setinputsizes(sizes)|设置允许的最大输入大小(必须有，但是实现是可选的)
setoutputsize(size[,col])|设置大列获取的最大缓冲区大小(必须有，但是实现是可选的)

### 类型对象和构造函数

通常，两个不同系统间的接口是最脆弱的。比如在 Python 对象和 C 类型中进行转换就是 这样。类似地，在 Python 对象和原生数据库对象间也存在这个问题。作为一个使用 Python 的 DB-API 的程序员，虽然你传递给数据库的参数是字符串，但是数据库可能需要将其转换 为多种不同的类型，从而可以对任何特定查询都能给出正确的数据类型。

例如，一个Python字符串是应该转换成VARCHAR、TEXT、BLOB，还是原生BINARY 对象，抑或是 DATE 或 TIME 对象呢?为数据库提供期望格式的输入必须非常小心，因此， DB-API 的另一个需求是创建构造函数，从而构建可以简单地转换成适当数据库对象的特 殊对象。表 6-7 给出了用于此目标的一些类。SQL 的 NULL 值对应于 Python 的 NULL 对象 None。

***

### 关系数据库

现在我们可以准备开始学习了，不过首先会有一个问题摆在我们面前:“Python 有哪些 数据库系统的接口呢?”或者说是:“Python 支持哪些平台呢?”答案是:“几乎所有的数据 库系统。”下面是一个大概(但不详尽)的接口列表。

商业 RDBMS

• IBM Informix
• Sybase
• Oracle
• Microsoft SQL Server
• IBM DB2
• SAP
• Embarcadero Interbase
• Ingres 

开源 RDBMS

• MySQL
• PostgreSQL
• SQLite
• Gadfly 数据库 API
• JDBC
• ODBC 

非关系数据库

• MongoDB
• Redis
• Cassandra
• SimpleDB
• Tokyo Cabinet
• CouchDB
• Bigtable(通过 Google App Engine 的数据库 API)

###  数据库和 Python:适配器

对于每种支持的数据库，Python 都有一个或多个适配器用于连接 Python 中的目标数 据库系统。比如 Sybase、SAP、Oracle 和 SQLServer 这些数据库就都存在多个可用的适配 器。我们需要做的事情就是挑选出最合适的适配器。你的挑选标准可能包括:它的性能如 何，它的文档和/或网站是否有用，是否有一个活跃的社区，驱动的质量和稳定性如何等。 需要记住的是，大多数适配器只提供给你连接数据库的基本需求，所以你还需要寻找一些 额外的特性。请记住，你需要负责编写更高级别的代码，比如线程管理和数据库连接池管 理等。

如果你不希望有太多的交互操作，比如你希望少写一些 SQL 语句，或者尽可能少地参与 数据库管理的细节，那么你可以考虑 ORM，本话题将在本章后面的小节中进行展开。

现在，让我们看几个使用适配器模块与关系数据库进行通信的例子。真正的秘密在于建 立连接。一旦你建立连接，并使用 DB-API 的对象、属性和对象方法，你的核心代码就会看 起来很相似，而无须去管它使用了哪个适配器以及 RDBMS。
