# 概述

在计算机术语中，线程是指机器中连续的、顺序的属性集合。一个线程包含执行一系列机器指令所必须的机器状态，包括当前指令位置、地址和数据寄存器等。

一个UNIX进程可以理解为一个线程加上地址空间、文件表述符合其他数据。某些UNIX版本支持"轻量级"或”变量级“进程，以便可以从进程中剔除部分或者所有数据，从而实现高效性能。既然线程和轻量级进程都需要地址空间、文件描述符等数据，那么区别何在？区别在于多个线程可以共享一个地址空间，而做不同的事情。在多处理器系统中，一个进程中的多个线程可以同时做不同的工作。

当计算机还活在玻璃洞穴中时，需要处理事先准备好的穿孔卡片。整个外部世界都在等待计算的结果，顶多可能订到程序员的抱怨声。但是外部世界并不是一次只做一件事情，逐渐的，计算机开始模拟这种实际模式，增加多程序设计、多重处理、分时共享、多处理器系统的能力，最终，实现了线程。

线程能够帮助你的应用程序走出洞穴。Pthreads则能帮你以一种优雅、高效、可移植的方式完成这个工作。本章简单介绍理解和使用线程所需要的基础知识，其他章节则会针对各个环节做进一步的详细解释。

## 1.1 舀水的程序员

```
三个程序员乘一艘小船出海，他们尽情享受着阳光和海风，离岸越来越远。一会儿，天色变暗，暴风雨降临，小船在狂风骇浪中颠簸，当暴风雨终于减缓的时候，他们已经失去了桅杆和帆，而且小船也裂了一个小缝，他们看不到陆地的影子。

小船上配备了食物、水、桨和一个水桶，程序员们开始工作，一个人划船、监视船舱的渗水情况，其他两个则可能去睡觉、检测水位、寻找陆地或者其他船只。

空闲的程序员可能看到水位上升，开始用桶舀水。当两个程序员醒来的时候，可能同时发现了水位的上升，都要去拿水桶。显然只有一个人首先拿到水桶，而另一个人则不得不等待。

如果两个人都睡着了，而划船的人认为该舀水的时候，通常他会推醒其中一个人而让另一个人继续睡觉。但是，如果划船的人心情不好，则可能大声喊叫，将两个人都吵醒。在让其中一个继续该做的工作时，另一个可以继续睡觉。

当划船的人疲劳时，他可以唤醒其中一个接替他的工作，然后马上睡觉，知道他被再次唤醒。这样，三个程序员就可以坚持它们的旅程了。
```

那么，舀水的程序员和线程到底有什么关系呢？答案是，上述故事可用来比喻线程编程模型的思想。后面我们还会给出更多的比喻，甚至继续扩展这个故事。不过，目前我们考虑以下几个基本点：

一个程序员就是一个独立活动的实体。在此处，程序员代表线程。尽管一个线程无法和一个程序员相比，然而，在代表编程模式中的活动元素方面，还是足够了。

舀水的痛和划船的桨就是一次只能由一个人拥有的令牌，它们也可以被理解为共享数据，或者是同步对象。顺便提一句，在pthread中的同步对象称为互斥量（mutex)。

轻推和喊叫是与同步对象相关的通信机制，个体等待这些事件的发生。pthread提供了条件变量，可以通过信号和广播来指示共享数据的状态变化。

## 1.2 术语定义

### 1.2.1 异步

异步表明事情相互独立地发生，除非有强加的依赖性。生活也是异步的。依赖性是大自然补充的，彼此相互不干的事件可以同步发生。没有桨，程序员无法划船；没有水桶，程序员也不能高效地舀水。但是，在一个程序员可以用桨划船的，同时，另一个程序可以用桶舀水。不过，传统的计算机系统让所有的事件依次发生，为了让它们并发，程序员必须使用额外的方法。

异步带来的最大复杂性就是：如果你没有同时执行多个活动，那么异步就没有什么优势。如果你开始了一个异步活动，然后什么也不做等待它结束，则你并没有从异步那儿获得太多好处。

### 1.22 并发

在字典中，并发的意思是指事情同时发生。在本书中，并发是指让实际上可能串行发生的事情好像同时发生一样。并发描述了单处理器系统中线程或进程的行为特点。在POSIX中，并发的定义要求“延迟调用线程的函数不应该导致其线程的无限期延迟”。

并发操作之间可能任意交错，导致程序互相独立地运行，但是并发不代表操作同时进行。然而，并发让程序利用异步的有点，在无关操作运行的过程中继续工作。

大部分程序拥有异步特点，但可能不很明显。例如，用户更喜欢异步界面，它们希望在思考的同时让程序接受它们发出的命令，即使程序还没有处理完上一个请求。

### 单处理器和多处理器

“单处理器”和“多处理器”是相当直接的两个词，不过为了避免混淆，我们还是定义它们。单处理器是指一台计算机只有一个编程人员可见的执行单元（处理器）。对于拥有超标量体系结构、向量或者其他数学或I/O协处理器的单一通用处理器，我们仍把它当成单处理器。

多处理器是指一台计算机拥有多个处理器，它们共享同一个指令集和相同的物理内存。虽然处理器不必同等地访问所有的物理内存，但是每一个应该都能方巍大部分内存。就本书而言，一个大型并行处理系统（MPP)可能是也不是我们说说的多处理器系统。许多MPP系统是属于多处理器系统的，因为所有的处理器都能访问所有的物理内存，即使访问时间的变化会很大。

### 1.2.4 并行

并行指并发序列同时执行。换言之，软件中的“并行”和日常语言中的“并发”是相同的意思，而区别于软件中的“并发”。并行的补充含义是指事情在相同的方向上独立进行。

真正的并行只能在多处理器系统中存在，但是并发可以在单处理器和多处理器系统中都存在。并行要求程序能够给同时执行多个操作，而并发只要求程序能够假装同时执行多个操作。

### 1.2.5 线程安全和可重入

线程安全是指代码能够被多个线程调用而不会产生灾难性结果。它不要求代码在多个线程中高效地运行，只要求能够安全地运行。大部分现行函数可以利用pthread提供的工具---互斥量、条件变量和线程私有数据，实现线程的安全。不需要保存永久状态的函数，可以通过整个函数调用的串行化实现线程安全。比如，在进入函数时加锁，在退出函数时解锁。这样的函数可以被多个线程调用，但一次只能有一个线程调用它。


